<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Evaluaci√≥n de Dep√≥sitos - Georgalos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f3f4f6;
      color: #111827;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #app-root {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }

    h1, h2, h3 {
      font-weight: 600;
      color: #111827;
    }

    h1 {
      font-size: 1.7rem;
      margin-bottom: 8px;
    }

    h2 {
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    h3 {
      font-size: 1.05rem;
      margin-bottom: 6px;
    }

    p {
      color: #4b5563;
    }

    .muted {
      font-size: 0.85rem;
      color: #6b7280;
    }

    input, select, button, textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 0.95rem;
      background: #ffffff;
      color: #111827;
      outline: none;
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.35);
    }

    textarea {
      resize: vertical;
    }

    button {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #ffffff;
      font-weight: 600;
      padding: 8px 16px;
      transition: transform 0.1s, box-shadow 0.1s, filter 0.1s;
      width: auto;
      min-width: 120px;
      text-align: center;
      border-radius: 999px;
    }

    button:hover {
      filter: brightness(1.05);
      box-shadow: 0 8px 20px rgba(22, 163, 74, 0.35);
      transform: translateY(-1px);
    }

    button.secondary {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
      box-shadow: none;
    }

    button.secondary:hover {
      box-shadow: 0 6px 18px rgba(148, 163, 184, 0.35);
    }

    .btn-danger {
      background: #dc2626;
      color: #ffffff;
    }

    .btn-small {
      font-size: 0.8rem;
      padding: 4px 10px;
      min-width: 0;
      border-radius: 999px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .col-2 {
      flex: 1 1 50%;
      min-width: 260px;
    }

    .col-3 {
      flex: 1 1 33%;
      min-width: 220px;
    }

    .mt-1 { margin-top: 4px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .mt-6 { margin-top: 24px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }

    .center { text-align: center; }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #15803d;
      font-size: 0.75rem;
      border: 1px solid #bbf7d0;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .nav button {
      flex: 1 1 auto;
      min-width: 140px;
      background: #f9fafb;
      color: #4b5563;
      border: 1px solid #e5e7eb;
      box-shadow: none;
      border-radius: 999px;
    }

    .nav button.active {
      background: #16a34a;
      color: #ffffff;
      border-color: #16a34a;
      box-shadow: 0 8px 20px rgba(22, 163, 74, 0.35);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
      background: #ffffff;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 500;
      color: #4b5563;
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
      color: #374151;
    }

    .pill-green {
      background: #dcfce7;
      color: #15803d;
    }

    .pill-yellow {
      background: #fef9c3;
      color: #854d0e;
    }

    .pill-red {
      background: #fee2e2;
      color: #b91c1c;
    }

    .summary-box {
      padding: 8px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .summary-metric {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .summary-label {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .summary-value {
      font-weight: 600;
      color: #111827;
    }

    /* Splash */
    #splash {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #bbf7d0 0, transparent 55%),
                  #f3f4f6;
      z-index: 50;
    }

    .splash-inner {
      text-align: center;
      max-width: 360px;
      padding: 24px;
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }

    .splash-logo {
      width: 90px;
      height: 90px;
      border-radius: 999px;
      margin: 0 auto 12px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .splash-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-top: 16px;
      position: relative;
    }

    .progress-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #16a34a, #22c55e);
      transition: width 0.15s linear;
    }

    #login-view {
      display: none;
      max-width: 400px;
      margin: 40px auto 0;
    }

    #main-view {
      display: none;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .topbar-user {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .badge-role {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #1d4ed8;
      width: fit-content;
    }

    .error-text {
      font-size: 0.8rem;
      color: #b91c1c;
      margin-top: 4px;
    }

    .scroll-y {
      max-height: 260px;
      overflow-y: auto;
    }

    .scroll-y-big {
      max-height: 330px;
      overflow-y: auto;
    }

    /* Cartel sincronizaci√≥n */
    #sync-status {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #111827;
      color: #f9fafb;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.85rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      border: 1px solid #e5e7eb;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 60;
    }

    /* Contenedor ancho para PDF de premios */
    #bonus-pdf {
      width: 1100px;
      max-width: 100%;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      body {
        align-items: flex-start;
      }

      #app-root {
        padding: 10px;
      }

      .card {
        padding: 16px;
        border-radius: 14px;
      }

      h1 {
        font-size: 1.4rem;
      }

      #login-view {
        margin-top: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash">
    <div class="splash-inner">
      <div class="splash-logo">
        <img src="https://www.georgalos.com.ar/wp-content/uploads/2024/08/georgalos-3.png" alt="Logo Georgalos" />
      </div>
      <h2>Evaluador de Dep√≥sitos</h2>
      <p class="muted mt-2">Cargando tablero de desempe√±o mensual...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="splash-progress"></div>
      </div>
    </div>
  </div>

  <div id="app-root">
    <!-- LOGIN -->
    <div id="login-view">
      <div class="card">
        <h1>Iniciar sesi√≥n üîê</h1>
        <p class="muted mb-4">Seleccion√° tu usuario y arranc√° a evaluar dep√≥sitos üöÄ.</p>

        <div class="mt-2">
          <label for="login-user-select" class="muted">Usuario üë§</label>
          <select id="login-user-select">
            <option value="luis.reynosa@georgalos.com.ar">luis.reynosa@georgalos.com.ar</option>
            <option value="marco.vallozzi@georgalos.com.ar">marco.vallozzi@georgalos.com.ar</option>
          </select>
        </div>

        <div class="mt-2">
          <label for="login-password" class="muted">Contrase√±a üîë</label>
          <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div id="login-error" class="error-text" style="display:none;"></div>

        <div class="mt-4">
          <button onclick="handleLogin()">Ingresar üöÄ</button>
        </div>

        <p class="muted mt-4" style="font-size:0.75rem;">
          Login local con usuarios definidos en el c√≥digo ‚öôÔ∏è
        </p>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-view">
      <div class="topbar">
        <div class="topbar-user">
          <span class="muted" style="font-size:0.8rem;">Panel de control</span>
          <span id="user-name" style="font-weight:600;"></span>
          <span id="user-role" class="badge-role"></span>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="secondary btn-small" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div>
            <h1>Evaluaci√≥n de Dep√≥sitos üì¶</h1>
            <p class="muted mt-1">
              Configur√° dep√≥sitos, preguntas, operarios y evaluaciones mensuales con c√°lculo de premios.
            </p>
          </div>
          <div class="tag">
            <span class="tag-dot"></span>
            <span>Georgalos ¬∑ Versi√≥n inicial</span>
          </div>
        </div>

        <div class="nav mt-4">
          <button id="tab-btn-deposits" class="active" onclick="showTab('deposits')">
            Dep√≥sitos & Preguntas
          </button>
          <button id="tab-btn-operators" onclick="showTab('operators')">
            Operarios
          </button>
          <button id="tab-btn-evaluations" onclick="showTab('evaluations')">
            Evaluaciones
          </button>
          <button id="tab-btn-bonuses" onclick="showTab('bonuses')">
            Premios
          </button>
        </div>

        <!-- DEP√ìSITOS & PREGUNTAS -->
        <div id="tab-deposits" class="mt-4">
          <div class="row">
            <div class="col-2">
              <h2>Dep√≥sitos</h2>
              <p class="muted mb-2">Alta y listado de dep√≥sitos a evaluar.</p>

              <div>
                <label class="muted">Nombre del dep√≥sito</label>
                <input id="deposit-name" type="text" placeholder="Dep√≥sito Victoria" />
              </div>
              <div class="mt-2">
                <label class="muted">Descripci√≥n (opcional)</label>
                <textarea id="deposit-description" rows="2" placeholder="Dep√≥sito central, turno noche..."></textarea>
              </div>
              <div class="mt-3">
                <button onclick="addDeposit()">Agregar dep√≥sito</button>
              </div>

              <div class="mt-4 scroll-y">
                <table>
                  <thead>
                    <tr>
                      <th>Dep√≥sito</th>
                      <th>Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody id="deposit-list"></tbody>
                </table>
              </div>
            </div>

            <div class="col-2">
              <h2>Preguntas por dep√≥sito</h2>
              <p class="muted mb-2">Defin√≠ el cuestionario de cada dep√≥sito.</p>

              <div>
                <label class="muted">Dep√≥sito</label>
                <select id="question-deposit-select"></select>
              </div>

              <div class="mt-2">
                <label class="muted">Texto de la pregunta</label>
                <input id="question-text" type="text" placeholder="Orden y limpieza del sector..." />
              </div>

              <div class="mt-2">
                <label class="muted">Puntaje m√°ximo</label>
                <input id="question-max-points" type="number" min="0.5" step="0.5" value="2" />
              </div>

              <div class="mt-3">
                <button onclick="addQuestion()">Agregar pregunta</button>
              </div>

              <div class="mt-4 scroll-y-big">
                <table>
                  <thead>
                    <tr>
                      <th>Pregunta</th>
                      <th>Max</th>
                      <th>Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody id="question-list"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- OPERARIOS -->
        <div id="tab-operators" class="mt-4" style="display:none;">
          <div class="row">
            <div class="col-2">
              <h2>Operarios</h2>
              <p class="muted mb-2">Cada operario se asocia a un dep√≥sito.</p>

              <div>
                <label class="muted">Nombre del operario</label>
                <input id="operator-name" type="text" placeholder="Juan P√©rez" />
              </div>

              <div class="mt-2">
                <label class="muted">Dep√≥sito</label>
                <select id="operator-deposit-select"></select>
              </div>

              <div class="mt-3">
                <button onclick="addOperator()">Agregar operario</button>
              </div>
            </div>

            <div class="col-2">
              <h3 class="mt-2">Listado</h3>
              <div class="scroll-y-big">
                <table>
                  <thead>
                    <tr>
                      <th>Operario</th>
                      <th>Dep√≥sito</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="operator-list"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- EVALUACIONES -->
        <div id="tab-evaluations" class="mt-4" style="display:none;">
          <h2>Nueva evaluaci√≥n mensual</h2>
          <p class="muted mb-2">
            Eleg√≠ el dep√≥sito y el mes, complet√° los puntajes por pregunta y guard√° la evaluaci√≥n.
          </p>

          <div class="row mt-2">
            <div class="col-3">
              <label class="muted">Dep√≥sito</label>
              <select id="eval-deposit-select"></select>
            </div>
            <div class="col-3">
              <label class="muted">Mes</label>
              <input id="eval-month" type="month" />
            </div>
            <div class="col-3" style="align-self:flex-end;">
              <button onclick="loadQuestionsForEvaluation()">Cargar preguntas</button>
            </div>
          </div>

          <div id="eval-questions-block" class="mt-4" style="display:none;">
            <h3>Cuestionario</h3>
            <p class="muted" style="font-size:0.8rem;">
              Carg√° el puntaje de cada pregunta (0 hasta el m√°ximo). Pod√©s usar valores intermedios (ej: 1.5 sobre 2).
            </p>

            <div class="scroll-y-big">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Pregunta</th>
                    <th>Max</th>
                    <th>Puntaje otorgado</th>
                  </tr>
                </thead>
                <tbody id="eval-question-rows"></tbody>
              </table>
            </div>

            <div class="summary-box">
              <div class="summary-metric">
                <span class="summary-label">Puntaje obtenido</span>
                <span class="summary-value" id="summary-obtained">0</span>
              </div>
              <div class="summary-metric">
                <span class="summary-label">Puntaje posible</span>
                <span class="summary-value" id="summary-possible">0</span>
              </div>
              <div class="summary-metric">
                <span class="summary-label">% de calificaci√≥n</span>
                <span class="summary-value" id="summary-percent">0%</span>
              </div>
            </div>

            <div class="mt-3">
              <button onclick="saveEvaluation()">Guardar evaluaci√≥n</button>
            </div>
          </div>

          <!-- HISTORIAL DE EVALUACIONES + EXPORT -->
          <div id="evaluations-history-block" class="mt-6">
            <h2>Historial de evaluaciones</h2>
            <p class="muted mb-2">
              Consult√° todas las evaluaciones guardadas. Pod√©s filtrar por mes y exportar res√∫menes o el detalle de una evaluaci√≥n.
            </p>

            <div class="row mt-2">
              <div class="col-3">
                <label class="muted">Filtrar por mes (opcional)</label>
                <input id="history-month" type="month" />
              </div>
              <div class="col-3" style="align-self:flex-end;">
                <button class="secondary" onclick="loadEvaluationsHistory()">Buscar</button>
              </div>
              <div class="col-3" style="align-self:flex-end;">
                <button onclick="exportEvaluationsPDF()">Exportar listado a PDF</button>
              </div>
            </div>

            <div id="evaluations-history-pdf" class="mt-3">
              <h3 class="muted" id="evaluations-history-title">Listado de evaluaciones</h3>
              <div class="scroll-y-big mt-2">
                <table>
                  <thead>
                    <tr>
                      <th>Dep√≥sito</th>
                      <th>Mes</th>
                      <th>Puntaje obtenido</th>
                      <th>Puntaje posible</th>
                      <th>%</th>
                      <th>Detalle</th>
                    </tr>
                  </thead>
                  <tbody id="evaluations-history-rows"></tbody>
                </table>
              </div>
            </div>

            <!-- DETALLE DE UNA EVALUACI√ìN CON PREGUNTAS -->
            <div id="evaluation-detail-wrapper" class="mt-4" style="display:none;">
              <div class="row" style="justify-content:space-between; align-items:center;">
                <h2 id="evaluation-detail-title">Detalle de evaluaci√≥n</h2>
                <button onclick="exportEvaluationDetailPDF()">Exportar evaluaci√≥n a PDF</button>
              </div>

              <div id="evaluation-detail-pdf" class="mt-2">
                <!-- Se llena por JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- PREMIOS -->
        <div id="tab-bonuses" class="mt-4" style="display:none;">
          <h2>Premios por mes</h2>
          <p class="muted mb-2">
            Defin√≠ el premio base al 100% por operario y mes. El sistema calcula el premio real seg√∫n el % de evaluaci√≥n del dep√≥sito.
          </p>

          <div class="row mt-2">
            <div class="col-3">
              <label class="muted">Mes</label>
              <input id="bonus-month" type="month" />
            </div>
            <div class="col-3" style="align-self:flex-end;">
              <button onclick="loadBonuses()">Cargar informaci√≥n</button>
            </div>
            <div class="col-3" style="align-self:flex-end;">
              <button onclick="exportBonusesPDF()">Exportar premios a PDF</button>
            </div>
          </div>

          <div id="bonus-content" class="mt-4" style="display:none;">
            <div id="bonus-pdf">
              <h3 class="muted" id="bonus-title">Premios operarios</h3>
              <div class="scroll-y-big">
                <table>
                  <thead>
                    <tr>
                      <th>Operario</th>
                      <th>Dep√≥sito</th>
                      <th>% evaluaci√≥n</th>
                      <th>Premio base (100%)</th>
                      <th>Premio calculado</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="bonus-rows"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Cartel de sincronizaci√≥n -->
  <div id="sync-status">Sincronizando con Firebase...</div>

  <!-- Librer√≠a para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- L√ìGICA + FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      doc,
      deleteDoc,
      updateDoc,
      serverTimestamp,
      writeBatch,
      limit,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB46C16u-mEszandRusDbpH15uItifNNRE",
      authDomain: "evaluacion-depositos-rio2.firebaseapp.com",
      projectId: "evaluacion-depositos-rio2",
      storageBucket: "evaluacion-depositos-rio2.firebasestorage.app",
      messagingSenderId: "546945701628",
      appId: "1:546945701628:web:a13fc5cbf836aaf04f2979"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("Firebase inicializado OK");

    function showSync(message = "Sincronizando con Firebase...") {
      const el = document.getElementById("sync-status");
      if (!el) return;
      el.textContent = message;
      el.style.opacity = "1";
      el.style.pointerEvents = "auto";
    }

    function hideSync() {
      const el = document.getElementById("sync-status");
      if (!el) return;
      el.style.opacity = "0";
      el.style.pointerEvents = "none";
    }

    // LOGIN LOCAL
    const USERS = [
      {
        email: "luis.reynosa@georgalos.com.ar",
        password: "Lu1s#Geo2025",
        name: "Luis Reynosa",
        role: "Gerente"
      },
      {
        email: "marco.vallozzi@georgalos.com.ar",
        password: "M@rc0_Geo2025",
        name: "Marco Vallozzi",
        role: "Analista"
      }
    ];

    let currentUser = null;

    function openMainForUser(user) {
      currentUser = user;
      document.getElementById("user-name").textContent = user.name;
      document.getElementById("user-role").textContent = user.role;
      document.getElementById("login-view").style.display = "none";
      document.getElementById("main-view").style.display = "block";
      showTab("deposits");
      loadDeposits();
      loadOperators();
    }

    window.handleLogin = function () {
      const select = document.getElementById("login-user-select");
      const email = select.value;
      const password = document.getElementById("login-password").value.trim();
      const errorDiv = document.getElementById("login-error");
      errorDiv.style.display = "none";
      errorDiv.textContent = "";

      const user = USERS.find((u) => u.email === email);

      if (!user || user.password !== password) {
        errorDiv.textContent = "Usuario o contrase√±a incorrectos.";
        errorDiv.style.display = "block";
        return;
      }

      localStorage.setItem("geo_eval_user_email", user.email);
      openMainForUser(user);
    };

    window.logout = function () {
      currentUser = null;
      localStorage.removeItem("geo_eval_user_email");
      document.getElementById("main-view").style.display = "none";
      document.getElementById("login-view").style.display = "block";
      document.getElementById("login-password").value = "";
    };

    // TABS
    window.showTab = function (tab) {
      const tabs = ["deposits", "operators", "evaluations", "bonuses"];
      tabs.forEach((t) => {
        document.getElementById("tab-" + t).style.display = t === tab ? "block" : "none";
        const btn = document.getElementById("tab-btn-" + t);
        if (btn) {
          if (t === tab) btn.classList.add("active");
          else btn.classList.remove("active");
        }
      });

      if (tab === "deposits") {
        loadDeposits();
      } else if (tab === "operators") {
        loadOperators();
      } else if (tab === "evaluations") {
        loadDepositsIntoSelect("eval-deposit-select");
        loadEvaluationsHistory();
      }
    };

    // SPLASH
    function startSplash() {
      const splash = document.getElementById("splash");
      const progress = document.getElementById("splash-progress");
      let value = 0;
      const interval = setInterval(() => {
        value += Math.random() * 20;
        if (value >= 100) value = 100;
        progress.style.width = value + "%";
        if (value >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            splash.style.opacity = "0";
            splash.style.pointerEvents = "none";
            setTimeout(() => {
              splash.style.display = "none";

              const savedEmail = localStorage.getItem("geo_eval_user_email");
              const savedUser = USERS.find((u) => u.email === savedEmail);
              if (savedUser) {
                openMainForUser(savedUser);
              } else {
                document.getElementById("login-view").style.display = "block";
              }
            }, 300);
          }, 300);
        }
      }, 200);
    }

    document.addEventListener("DOMContentLoaded", () => {
      startSplash();
    });

    // DEP√ìSITOS
    window.addDeposit = async function () {
      const nameInput = document.getElementById("deposit-name");
      const descInput = document.getElementById("deposit-description");
      const name = nameInput.value.trim();
      const description = descInput.value.trim();

      if (!name) {
        alert("Ingres√° un nombre de dep√≥sito.");
        return;
      }

      try {
        showSync("Sincronizando dep√≥sito con Firebase...");
        await addDoc(collection(db, "deposits"), {
          name,
          description,
          createdAt: serverTimestamp()
        });
        nameInput.value = "";
        descInput.value = "";
        await loadDeposits();
        alert("Dep√≥sito agregado.");
      } catch (err) {
        console.error("Error addDeposit:", err);
        alert("Error guardando el dep√≥sito.");
      } finally {
        hideSync();
      }
    };

    async function loadDeposits() {
      try {
        const snapshot = await getDocs(collection(db, "deposits"));

        const listBody = document.getElementById("deposit-list");
        const selectQuestion = document.getElementById("question-deposit-select");
        const selectOperator = document.getElementById("operator-deposit-select");
        const selectEval = document.getElementById("eval-deposit-select");

        listBody.innerHTML = "";
        selectQuestion.innerHTML = "";
        selectOperator.innerHTML = "";
        if (selectEval) selectEval.innerHTML = "";

        snapshot.forEach((snapDoc) => {
          const d = snapDoc.data();
          const id = snapDoc.id;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.name || "(sin nombre)"}</td>
            <td>
              <button class="btn-small btn-danger" onclick="deleteDeposit('${id}')">Borrar</button>
            </td>
          `;
          listBody.appendChild(tr);

          const opt1 = document.createElement("option");
          opt1.value = id;
          opt1.textContent = d.name || "(sin nombre)";
          selectQuestion.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = id;
          opt2.textContent = d.name || "(sin nombre)";
          selectOperator.appendChild(opt2);

          if (selectEval) {
            const opt3 = document.createElement("option");
            opt3.value = id;
            opt3.textContent = d.name || "(sin nombre)";
            selectEval.appendChild(opt3);
          }
        });

        if (snapshot.size > 0) {
          loadQuestionsForSelectedDeposit();
          document.getElementById("question-deposit-select").onchange =
            loadQuestionsForSelectedDeposit;
        }
      } catch (err) {
        console.error("Error loadDeposits:", err);
        alert("Error cargando dep√≥sitos.");
      }
    }

    window.deleteDeposit = async function (id) {
      if (!confirm("¬øSeguro que quer√©s borrar este dep√≥sito?")) return;
      try {
        showSync("Eliminando dep√≥sito...");
        await deleteDoc(doc(db, "deposits", id));
        await loadDeposits();
      } catch (err) {
        console.error("Error deleteDeposit:", err);
        alert("Error borrando dep√≥sito.");
      } finally {
        hideSync();
      }
    };

    // PREGUNTAS
    window.addQuestion = async function () {
      const depositSelect = document.getElementById("question-deposit-select");
      const textInput = document.getElementById("question-text");
      const maxPointsInput = document.getElementById("question-max-points");

      const depositId = depositSelect.value;
      const text = textInput.value.trim();
      const maxPoints = parseFloat(maxPointsInput.value);

      if (!depositId) {
        alert("Seleccion√° un dep√≥sito.");
        return;
      }
      if (!text) {
        alert("Ingres√° el texto de la pregunta.");
        return;
      }
      if (isNaN(maxPoints) || maxPoints <= 0) {
        alert("Ingres√° un puntaje m√°ximo v√°lido.");
        return;
      }

      try {
        showSync("Sincronizando pregunta con Firebase...");

        const qRef = query(
          collection(db, "questions"),
          where("depositId", "==", depositId)
        );
        const snap = await getDocs(qRef);
        const newOrder = snap.size;

        await addDoc(collection(db, "questions"), {
          depositId,
          text,
          maxPoints,
          order: newOrder,
          active: true,
          createdAt: serverTimestamp()
        });
        textInput.value = "";
        maxPointsInput.value = "2";
        await loadQuestionsForSelectedDeposit();
      } catch (err) {
        console.error("Error addQuestion:", err);
        alert("Error guardando la pregunta.");
      } finally {
        hideSync();
      }
    };

    async function loadQuestionsForSelectedDeposit() {
      const depositSelect = document.getElementById("question-deposit-select");
      const depositId = depositSelect.value;
      const tbody = document.getElementById("question-list");
      tbody.innerHTML = "";

      if (!depositId) return;

      try {
        const qRef = query(
          collection(db, "questions"),
          where("depositId", "==", depositId)
        );
        const snapshot = await getDocs(qRef);

        const items = [];
        snapshot.forEach((snapDoc) => {
          items.push({ id: snapDoc.id, ...snapDoc.data() });
        });

        items.sort((a, b) => {
          const ao = typeof a.order === "number" ? a.order : 9999;
          const bo = typeof b.order === "number" ? b.order : 9999;
          return ao - bo;
        });

        items.forEach((q) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="white-space:pre-wrap;">${q.text}</td>
            <td>${q.maxPoints}</td>
            <td>
              <button class="btn-small" onclick="moveQuestion('${q.id}','up')">‚Üë</button>
              <button class="btn-small" onclick="moveQuestion('${q.id}','down')">‚Üì</button>
              <button class="btn-small btn-danger" onclick="deleteQuestion('${q.id}')">Borrar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loadQuestionsForSelectedDeposit:", err);
        alert("Error cargando preguntas.");
      }
    }

    window.deleteQuestion = async function (id) {
      if (!confirm("¬øSeguro que quer√©s borrar esta pregunta?")) return;
      try {
        showSync("Eliminando pregunta...");
        await deleteDoc(doc(db, "questions", id));
        await loadQuestionsForSelectedDeposit();
      } catch (err) {
        console.error("Error deleteQuestion:", err);
        alert("Error borrando pregunta.");
      } finally {
        hideSync();
      }
    };

    window.moveQuestion = async function (questionId, direction) {
      const depositSelect = document.getElementById("question-deposit-select");
      const depositId = depositSelect.value;
      if (!depositId) return;

      try {
        showSync("Reordenando preguntas...");

        const qRef = query(
          collection(db, "questions"),
          where("depositId", "==", depositId)
        );
        const snapshot = await getDocs(qRef);

        const items = [];
        snapshot.forEach((snapDoc) => {
          const data = snapDoc.data();
          items.push({
            id: snapDoc.id,
            order: typeof data.order === "number" ? data.order : 0,
            ...data
          });
        });

        items.sort((a, b) => a.order - b.order);
        items.forEach((it, idx) => {
          it.order = idx;
        });

        const idx = items.findIndex((q) => q.id === questionId);
        if (idx === -1) {
          hideSync();
          return;
        }

        const swapIdx = direction === "up" ? idx - 1 : idx + 1;
        if (swapIdx < 0 || swapIdx >= items.length) {
          hideSync();
          return;
        }

        const batch = writeBatch(db);
        batch.update(doc(db, "questions", items[idx].id), { order: swapIdx });
        batch.update(doc(db, "questions", items[swapIdx].id), { order: idx });
        await batch.commit();

        await loadQuestionsForSelectedDeposit();
      } catch (err) {
        console.error("Error moveQuestion:", err);
        alert("Error reordenando preguntas.");
      } finally {
        hideSync();
      }
    };

    // OPERARIOS
    window.addOperator = async function () {
      const nameInput = document.getElementById("operator-name");
      const depositSelect = document.getElementById("operator-deposit-select");

      const name = nameInput.value.trim();
      const depositId = depositSelect.value;

      if (!name) {
        alert("Ingres√° el nombre del operario.");
        return;
      }
      if (!depositId) {
        alert("Seleccion√° un dep√≥sito para el operario.");
        return;
      }

      try {
        showSync("Sincronizando operario con Firebase...");
        await addDoc(collection(db, "operators"), {
          name,
          depositId,
          active: true,
          createdAt: serverTimestamp()
        });
        nameInput.value = "";
        await loadOperators();
      } catch (err) {
        console.error("Error addOperator:", err);
        alert("Error guardando operario.");
      } finally {
        hideSync();
      }
    };

    async function loadDepositsIntoSelect(selectId) {
      try {
        const snapshot = await getDocs(collection(db, "deposits"));
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = "";
        snapshot.forEach((snapDoc) => {
          const d = snapDoc.data();
          const opt = document.createElement("option");
          opt.value = snapDoc.id;
          opt.textContent = d.name || "(sin nombre)";
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Error loadDepositsIntoSelect:", err);
      }
    }

    async function loadOperators() {
      try {
        const depSnap = await getDocs(collection(db, "deposits"));
        const depositsMap = {};
        depSnap.forEach((dSnap) => {
          depositsMap[dSnap.id] = dSnap.data().name || "Dep√≥sito";
        });

        const snapshot = await getDocs(query(collection(db, "operators"), orderBy("name")));
        const tbody = document.getElementById("operator-list");
        tbody.innerHTML = "";

        snapshot.forEach((snapDoc) => {
          const op = snapDoc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${op.name}</td>
            <td>${depositsMap[op.depositId] || "-"}</td>
            <td><button class="btn-small btn-danger" onclick="deleteOperator('${snapDoc.id}')">Borrar</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loadOperators:", err);
        alert("Error cargando operarios.");
      }
    }

    window.deleteOperator = async function (id) {
      if (!confirm("¬øSeguro que quer√©s borrar este operario?")) return;
      try {
        showSync("Eliminando operario...");
        await deleteDoc(doc(db, "operators", id));
        await loadOperators();
      } catch (err) {
        console.error("Error deleteOperator:", err);
        alert("Error borrando operario.");
      } finally {
        hideSync();
      }
    };

    // EVALUACIONES
    let evalQuestionsCache = [];
    let lastEvaluationDetailFileName = "evaluacion_detalle";

    window.loadQuestionsForEvaluation = async function () {
      const depositSelect = document.getElementById("eval-deposit-select");
      const monthInput = document.getElementById("eval-month");
      const depositId = depositSelect.value;
      const month = monthInput.value;

      if (!depositId) {
        alert("Seleccion√° un dep√≥sito.");
        return;
      }
      if (!month) {
        alert("Seleccion√° un mes.");
        return;
      }

      try {
        const qRef = query(
          collection(db, "questions"),
          where("depositId", "==", depositId)
        );
        const snapshot = await getDocs(qRef);

        evalQuestionsCache = [];
        const tbody = document.getElementById("eval-question-rows");
        tbody.innerHTML = "";

        let totalPossible = 0;
        let index = 1;

        const items = [];
        snapshot.forEach((snapDoc) => {
          items.push({ id: snapDoc.id, ...snapDoc.data() });
        });

        items.sort((a, b) => {
          const ao = typeof a.order === "number" ? a.order : 9999;
          const bo = typeof b.order === "number" ? b.order : 9999;
          return ao - bo;
        });

        items.forEach((q) => {
          evalQuestionsCache.push({ id: q.id, ...q });
          totalPossible += q.maxPoints;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${index}</td>
            <td>${q.text}</td>
            <td>${q.maxPoints}</td>
            <td>
              <input type="number" min="0" step="0.1" max="${q.maxPoints}"
                value="0" data-question-id="${q.id}" oninput="recalculateEvaluation()" />
            </td>
          `;
          tbody.appendChild(tr);
          index++;
        });

        if (evalQuestionsCache.length === 0) {
          alert("Este dep√≥sito no tiene preguntas configuradas.");
          document.getElementById("eval-questions-block").style.display = "none";
          return;
        }

        document.getElementById("eval-questions-block").style.display = "block";
        document.getElementById("summary-possible").textContent = totalPossible.toFixed(2);
        document.getElementById("summary-obtained").textContent = "0";
        document.getElementById("summary-percent").textContent = "0%";
      } catch (err) {
        console.error("Error loadQuestionsForEvaluation:", err);
        alert("Error cargando preguntas para evaluaci√≥n.");
      }
    };

    window.recalculateEvaluation = function () {
      const inputs = document.querySelectorAll("#eval-question-rows input[type='number']");
      let totalObtained = 0;
      let totalPossible = 0;

      evalQuestionsCache.forEach((q) => {
        totalPossible += q.maxPoints;
      });

      inputs.forEach((inp) => {
        const val = parseFloat(inp.value);
        if (!isNaN(val)) totalObtained += val;
      });

      const percent = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;

      document.getElementById("summary-obtained").textContent = totalObtained.toFixed(2);
      document.getElementById("summary-possible").textContent = totalPossible.toFixed(2);
      document.getElementById("summary-percent").textContent = percent.toFixed(1) + "%";
    };

    window.saveEvaluation = async function () {
      const depositSelect = document.getElementById("eval-deposit-select");
      const monthInput = document.getElementById("eval-month");
      const depositId = depositSelect.value;
      const month = monthInput.value;

      if (!depositId || !month) {
        alert("Seleccion√° dep√≥sito y mes.");
        return;
      }
      if (evalQuestionsCache.length === 0) {
        alert("No hay preguntas para evaluar.");
        return;
      }

      const inputs = document.querySelectorAll("#eval-question-rows input[type='number']");
      let answers = [];
      let totalObtained = 0;
      let totalPossible = 0;

      evalQuestionsCache.forEach((q) => {
        totalPossible += q.maxPoints;
      });

      try {
        inputs.forEach((inp) => {
          const qid = inp.getAttribute("data-question-id");
          const val = parseFloat(inp.value);
          const score = isNaN(val) ? 0 : val;
          const question = evalQuestionsCache.find((q) => q.id === qid);
          if (!question) return;
          if (score > question.maxPoints) {
            throw new Error("Puntaje mayor al m√°ximo en alguna pregunta.");
          }
          answers.push({
            questionId: qid,
            questionText: question.text || "",
            score,
            maxPoints: question.maxPoints
          });
          totalObtained += score;
        });
      } catch (err) {
        alert("Hay una pregunta con puntaje mayor al m√°ximo permitido.");
        return;
      }

      const percent = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;

      showSync("Sincronizando evaluaci√≥n con Firebase...");

      try {
        const evalRef = await addDoc(collection(db, "evaluations"), {
          depositId,
          month,
          totalObtained,
          totalPossible,
          percent,
          createdAt: serverTimestamp()
        });

        const batch = writeBatch(db);
        answers.forEach((ans) => {
          const ansRef = doc(collection(db, "evaluations", evalRef.id, "answers"));
          batch.set(ansRef, ans);
        });
        await batch.commit();

        alert("Evaluaci√≥n guardada correctamente. %: " + percent.toFixed(1) + "%");
      } catch (err) {
        console.error("Error saveEvaluation:", err);
        alert("Error guardando evaluaci√≥n.");
      } finally {
        hideSync();
      }
    };

    // HISTORIAL DE EVALUACIONES
    window.loadEvaluationsHistory = async function () {
      try {
        const monthFilter = document.getElementById("history-month").value;
        const tbody = document.getElementById("evaluations-history-rows");
        const title = document.getElementById("evaluations-history-title");

        const depSnap = await getDocs(collection(db, "deposits"));
        const depositsMap = {};
        depSnap.forEach((dSnap) => {
          depositsMap[dSnap.id] = dSnap.data().name || "Dep√≥sito";
        });

        let evalSnap;
        if (monthFilter) {
          const qRef = query(
            collection(db, "evaluations"),
            where("month", "==", monthFilter)
          );
          evalSnap = await getDocs(qRef);
          title.textContent = "Evaluaciones del mes " + monthFilter;
        } else {
          evalSnap = await getDocs(collection(db, "evaluations"));
          title.textContent = "Evaluaciones de todos los meses";
        }

        tbody.innerHTML = "";

        if (evalSnap.empty) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="6" class="muted">No hay evaluaciones registradas.</td>`;
          tbody.appendChild(tr);
          return;
        }

        evalSnap.forEach((docSnap) => {
          const e = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${depositsMap[e.depositId] || "-"}</td>
            <td>${e.month || "-"}</td>
            <td>${(e.totalObtained ?? 0).toFixed(2)}</td>
            <td>${(e.totalPossible ?? 0).toFixed(2)}</td>
            <td>${(e.percent ?? 0).toFixed(1)}%</td>
            <td><button class="btn-small" onclick="showEvaluationDetail('${docSnap.id}')">Ver detalle</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loadEvaluationsHistory:", err);
        alert("Error cargando historial de evaluaciones.");
      }
    };

    window.exportEvaluationsPDF = function () {
      const tbody = document.getElementById("evaluations-history-rows");
      if (!tbody || tbody.children.length === 0) {
        alert("No hay evaluaciones para exportar.");
        return;
      }
      const monthFilter = document.getElementById("history-month").value || "todas";
      const element = document.getElementById("evaluations-history-pdf");
      const opt = {
        margin: 10,
        filename: `evaluaciones_${monthFilter}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };
      window.html2pdf().set(opt).from(element).save();
    };

    // DETALLE DE UNA EVALUACI√ìN
    window.showEvaluationDetail = async function (evalId) {
      try {
        showSync("Cargando detalle de evaluaci√≥n...");
        const evalRef = doc(db, "evaluations", evalId);
        const evalSnap = await getDoc(evalRef);
        if (!evalSnap.exists()) {
          alert("No se encontr√≥ la evaluaci√≥n seleccionada.");
          hideSync();
          return;
        }

        const e = evalSnap.data();

        let depName = "Dep√≥sito";
        try {
          const depRef = doc(db, "deposits", e.depositId);
          const depSnap = await getDoc(depRef);
          if (depSnap.exists()) {
            depName = depSnap.data().name || depName;
          }
        } catch (_) {}

        const answersSnap = await getDocs(
          collection(db, "evaluations", evalId, "answers")
        );

        const answers = [];
        answersSnap.forEach((aSnap) => {
          answers.push(aSnap.data());
        });

        answers.sort((a, b) => (a.questionText || "").localeCompare(b.questionText || ""));

        const wrapper = document.getElementById("evaluation-detail-wrapper");
        const container = document.getElementById("evaluation-detail-pdf");
        const title = document.getElementById("evaluation-detail-title");

        title.textContent = `Detalle evaluaci√≥n - ${depName} (${e.month || "-"})`;
        lastEvaluationDetailFileName =
          `evaluacion_${depName.replace(/\s+/g, "_")}_${(e.month || "sin_mes")}`;

        let rowsHtml = "";
        let idx = 1;
        answers.forEach((ans) => {
          const qText = ans.questionText || "(pregunta sin texto)";
          const maxP = ans.maxPoints ?? 0;
          const score = ans.score ?? 0;
          const percent = maxP > 0 ? (score / maxP) * 100 : 0;
          rowsHtml += `
            <tr>
              <td>${idx}</td>
              <td>${qText}</td>
              <td>${maxP.toFixed(2)}</td>
              <td>${score.toFixed(2)}</td>
              <td>${percent.toFixed(1)}%</td>
            </tr>
          `;
          idx++;
        });

        if (answers.length === 0) {
          rowsHtml = `<tr><td colspan="5" class="muted">No hay respuestas registradas para esta evaluaci√≥n.</td></tr>`;
        }

        container.innerHTML = `
          <div style="padding:8px 0;">
            <h3>Resumen</h3>
            <p class="muted">
              Dep√≥sito: <strong>${depName}</strong><br>
              Mes: <strong>${e.month || "-"}</strong><br>
              Puntaje obtenido: <strong>${(e.totalObtained ?? 0).toFixed(2)}</strong> /
              <strong>${(e.totalPossible ?? 0).toFixed(2)}</strong> (${(e.percent ?? 0).toFixed(1)}%)
            </p>
          </div>

          <div class="mt-3">
            <h3>Detalle de preguntas</h3>
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Pregunta</th>
                  <th>Max</th>
                  <th>Puntaje obtenido</th>
                  <th>% pregunta</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;

        wrapper.style.display = "block";
      } catch (err) {
        console.error("Error showEvaluationDetail:", err);
        alert("Error cargando el detalle de la evaluaci√≥n.");
      } finally {
        hideSync();
      }
    };

    window.exportEvaluationDetailPDF = function () {
      const wrapper = document.getElementById("evaluation-detail-wrapper");
      if (!wrapper || wrapper.style.display === "none") {
        alert("Primero seleccion√° una evaluaci√≥n y carg√° su detalle.");
        return;
      }

      const element = wrapper;
      const opt = {
        margin: 10,
        filename: `${lastEvaluationDetailFileName}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      window.html2pdf().set(opt).from(element).save();
    };

    // PREMIOS
    window.loadBonuses = async function () {
      const monthInput = document.getElementById("bonus-month");
      const month = monthInput.value;
      if (!month) {
        alert("Seleccion√° un mes.");
        return;
      }

      try {
        const depSnap = await getDocs(collection(db, "deposits"));
        const depositsMap = {};
        depSnap.forEach((dSnap) => {
          depositsMap[dSnap.id] = dSnap.data().name || "Dep√≥sito";
        });

        const operatorsSnap = await getDocs(collection(db, "operators"));
        const operators = [];
        operatorsSnap.forEach((opSnap) => {
          operators.push({ id: opSnap.id, ...opSnap.data() });
        });

        const evalsSnap = await getDocs(
          query(collection(db, "evaluations"), where("month", "==", month))
        );
        const evalsByDeposit = {};
        evalsSnap.forEach((evSnap) => {
          const e = evSnap.data();
          const depId = e.depositId;
          const existing = evalsByDeposit[depId];
          if (
            !existing ||
            (existing.createdAt && e.createdAt && e.createdAt.toMillis() > existing.createdAt.toMillis())
          ) {
            evalsByDeposit[depId] = e;
          }
        });

        const bonusesSnap = await getDocs(
          query(collection(db, "bonuses"), where("month", "==", month))
        );
        const bonusMap = {};
        bonusesSnap.forEach((bSnap) => {
          const b = bSnap.data();
          bonusMap[b.operatorId] = b;
        });

        const tbody = document.getElementById("bonus-rows");
        tbody.innerHTML = "";

        operators.forEach((op) => {
          const depName = depositsMap[op.depositId] || "-";
          const evalData = evalsByDeposit[op.depositId];
          const percent = evalData ? evalData.percent : 0;

          const bonusData = bonusMap[op.id];
          const baseAmount = bonusData ? bonusData.baseAmount : 0;
          const calculated = baseAmount * (percent / 100);

          let pillClass = "pill-red";
          if (percent >= 90) pillClass = "pill-green";
          else if (percent >= 70) pillClass = "pill-yellow";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${op.name}</td>
            <td>${depName}</td>
            <td>
              <span class="pill ${pillClass}">
                ${percent.toFixed(1)}%
              </span>
            </td>
            <td>
              <input type="number" min="0" step="0.01" value="${baseAmount.toFixed(2)}"
                data-operator-id="${op.id}" data-percent="${percent}" />
            </td>
            <td>
              <span>$ ${calculated.toFixed(2)}</span>
            </td>
            <td>
              <button class="btn-small" onclick="saveBonusForOperator('${op.id}')">Guardar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("bonus-content").style.display = "block";
        document.getElementById("bonus-title").textContent =
          "Premios operarios - Mes " + month;

        const inputs = tbody.querySelectorAll("input[type='number']");
        inputs.forEach((inp) => {
          inp.oninput = () => {
            const percent = parseFloat(inp.getAttribute("data-percent")) || 0;
            const baseAmount = parseFloat(inp.value) || 0;
            const row = inp.closest("tr");
            const spanCalc = row.querySelector("td:nth-child(5) span");
            spanCalc.textContent = "$ " + (baseAmount * (percent / 100)).toFixed(2);
          };
        });

      } catch (err) {
        console.error("Error loadBonuses:", err);
        alert("Error cargando premios.");
      }
    };

    window.saveBonusForOperator = async function (operatorId) {
      const monthInput = document.getElementById("bonus-month");
      const month = monthInput.value;
      if (!month) {
        alert("Seleccion√° un mes.");
        return;
      }

      const input = document.querySelector(`input[data-operator-id="${operatorId}"]`);
      if (!input) return;

      const baseAmount = parseFloat(input.value);
      if (isNaN(baseAmount) || baseAmount < 0) {
        alert("Ingres√° un monto v√°lido para el premio base.");
        return;
      }

      showSync("Sincronizando premio con Firebase...");

      try {
        const qRef = query(
          collection(db, "bonuses"),
          where("operatorId", "==", operatorId),
          where("month", "==", month),
          limit(1)
        );
        const snap = await getDocs(qRef);

        if (!snap.empty) {
          const docId = snap.docs[0].id;
          await updateDoc(doc(db, "bonuses", docId), { baseAmount });
        } else {
          await addDoc(collection(db, "bonuses"), {
            operatorId,
            month,
            baseAmount,
            createdAt: serverTimestamp()
          });
        }

        alert("Premio base guardado.");
      } catch (err) {
        console.error("Error saveBonusForOperator:", err);
        alert("Error guardando premio.");
      } finally {
        hideSync();
      }
    };

    window.exportBonusesPDF = function () {
      const tbody = document.getElementById("bonus-rows");
      if (!tbody || tbody.children.length === 0) {
        alert("Primero carg√° un mes de premios.");
        return;
      }

      const month = document.getElementById("bonus-month").value || "sin_mes";
      const element = document.getElementById("bonus-pdf");

      const originalWidth = element.style.width;
      const originalMargin = element.style.margin;

      element.style.width = "1100px";
      element.style.margin = "0 auto";

      const opt = {
        margin: 10,
        filename: `premios_${month}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
      };

      window.html2pdf()
        .set(opt)
        .from(element)
        .save()
        .then(() => {
          element.style.width = originalWidth;
          element.style.margin = originalMargin;
        })
        .catch(err => {
          console.error("Error exportBonusesPDF:", err);
          alert("Error exportando premios a PDF.");
          element.style.width = originalWidth;
          element.style.margin = originalMargin;
        });
    };
  </script>
</body>
</html>
